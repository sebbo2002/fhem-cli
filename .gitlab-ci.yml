stages:
  - test
  - publish

node_8:
  image: node:8
  services:
    - docker:dind
  stage: test
  tags:
    - matt.sebbo.net
    - docker
  script:
    - npm install
    - npm test

node_9:
  image: node:9
  services:
    - docker:dind
  stage: test
  tags:
    - matt.sebbo.net
    - docker
  script:
    - npm install
    - npm test

node_10:
  image: node:10
  services:
    - docker:dind
  stage: test
  tags:
    - matt.sebbo.net
    - docker
  script:
    - npm install
    - npm test

node_report:
  stage: test
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - yarn install
    - npm run tests
    - rm -rf /var/docker/static/fhem-cli/*
    - mv ./test-result/* /var/docker/static/fhem-cli/

publish_github:
  stage: publish
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - git checkout $CI_COMMIT_REF_NAME
    - git pull
    - git push --force "https://${GITHUB_AUTH}@github.com/sebbo2002/fhem-cli.git" --all
    - git push --force "https://${GITHUB_AUTH}@github.com/sebbo2002/fhem-cli.git" --tags
  except:
    - tags

publish_github_tags:
  stage: publish
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - git push --force "https://${GITHUB_AUTH}@github.com/sebbo2002/fhem-cli.git" --tags

publish_npm:
  stage: publish
  tags:
    - matt.sebbo.net
    - ssh
  script:
    - npm config set //registry.npmjs.org/:_authToken $NPM_TOKEN
    - yarn install
    - npm run bump
    - npm publish
  only:
    - tags
